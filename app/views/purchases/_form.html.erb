<%# app/views/purchases/new.html.erb %>

<div class="p-4">
  <h1 class="text-2xl font-bold mb-4">Nueva Compra</h1>

  <%= form_with(model: @purchase, data: { controller: "purchases-form" }) do |f| %>
    <!-- Purchase date -->
    <div class="mb-4">
      <label class="block mb-1">Purchase date *</label>
      <%= f.date_select :purchase_date, {}, { class: "border rounded px-2 py-1 mr-2" } %>
    </div>

    <!-- Expected date -->
    <div class="mb-4">
      <label class="block mb-1">Fecha de Entrega Esperada *</label>
      <%= f.date_select :expected_date, {}, { class: "border rounded px-2 py-1 mr-2" } %>
    </div>

    <!-- Supplier -->
    <div class="mb-4">
      <label class="block mb-1">Supplier</label>
      <%= f.collection_select :supplier_id,
          @suppliers,
          :id,
          :company_name,
          { prompt: "Seleccionar proveedor" },
          { class: "w-full border rounded px-2 py-1" } %>
    </div>

    <h2 class="text-xl font-bold mb-4">Detalles de Productos</h2>

    <div class="flex gap-4 items-end mb-4">
      <div>
        <label class="block mb-1">Category</label>
        <%= select_tag :category,
            options_for_select(@products.pluck(:category).uniq.compact),
            {
              prompt: "Seleccionar categorÃ­a",
              class: "border rounded px-2 py-1",
              data: {
                purchases_form_target: "categorySelect",
                action: "change->purchases-form#filterProducts"
              }
            } %>
      </div>

      <div>
        <label class="block mb-1">Product</label>
        <%= select_tag :product_id,
            options_for_select([]),
            {
              prompt: "Seleccionar producto",
              class: "border rounded px-2 py-1",
              data: {
                purchases_form_target: "productSelect",
                action: "change->purchases-form#updatePrice"
              }
            } %>
      </div>

      <div>
        <label class="block mb-1">Quantity *</label>
        <%= number_field_tag :quantity,
            1,
            class: "border rounded px-2 py-1 w-20",
            data: { purchases_form_target: "quantityInput" } %>
      </div>

      <div>
        <label class="block mb-1">Unit price *</label>
        <%= text_field_tag :unit_price,
            "0.00",
            class: "border rounded px-2 py-1 w-24 bg-gray-50",
            readonly: true,
            data: { purchases_form_target: "unitPriceDisplay" } %>
      </div>

      <button type="button"
              class="bg-green-500 text-white px-4 py-1 rounded"
              data-action="click->purchases-form#addProduct">
        Agregar Producto
      </button>
    </div>

    <h2 class="text-xl font-bold mb-4">Resumen de Compra</h2>

    <table class="w-full mb-4">
      <thead>
        <tr class="border-b">
          <th class="text-left py-2">Producto</th>
          <th class="text-left py-2">Precio</th>
          <th class="text-left py-2">Cantidad</th>
          <th class="text-left py-2">Total</th>
          <th class="text-left py-2">Acciones</th>
        </tr>
      </thead>
      <tbody data-purchases-form-target="productsList">
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3" class="text-right py-2">Total:</td>
          <td class="py-2">$<span data-purchases-form-target="total">0.00</span></td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <%= f.hidden_field :total_price, data: { purchases_form_target: "totalInput" } %>

    <div class="flex gap-2">
      <%= f.submit "Create Purchase", class: "bg-red-500 text-white px-4 py-2 rounded" %>
      <%= link_to "Continue", purchases_path, class: "bg-gray-200 px-4 py-2 rounded" %>
    </div>
  <% end %>
</div>
